#!/usr/bin/env bash
set -euo pipefail

# 解析安装根目录
BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$BIN_DIR/.." && pwd)"
export OK_CPP_ROOT="$ROOT_DIR"
MODULES_DIR="$ROOT_DIR/lib/ok-cpp/modules"
VERSION_FILE="$ROOT_DIR/lib/ok-cpp/VERSION"
VERSION="unknown"
[[ -f "$VERSION_FILE" ]] && VERSION="$(cat "$VERSION_FILE")"

print_version() {
  echo "ok-cpp version $VERSION"
}

print_help() {
cat <<'EOF'
ok-cpp - C++ learning playground (CMake based)

Usage:
  ok-cpp <command> [options]

Commands:
  mkp (m)           Create a new CMake C++ project
  run (r)           Build & run a CMake project
  doctor (d)        Check development environment
  config (c)        config file
  help (h)          Show this help message

Options:
  -h, --help        Show help for a command

Examples:
  ok-cpp mkp demo/hello  (or: ok-cpp m demo/hello)
  ok-cpp run             (or: ok-cpp r)
  ok-cpp run demo/hello  (or: ok-cpp r demo/hello)
  ok-cpp doctor          (or: ok-cpp d)
EOF
}

# 命令映射函数:将简写映射到完整命令
resolve_command() {
  local input="$1"
  case "$input" in
    m) echo "mkp" ;;
    r) echo "run" ;;
    d) echo "doctor" ;;
    c) echo "config" ;;
    h) echo "help" ;;
    mkp|run|doctor|config|help) echo "$input" ;;
    *) echo "" ;;
  esac
}

cmd="${1:-}"

case "$cmd" in
  -v|--version)
    print_version
    exit 0
    ;;
  -h|--help|"")
    print_help
    exit 0
    ;;
  *)
    # 解析命令(支持简写)
    resolved_cmd="$(resolve_command "$cmd")"
    
    if [[ "$resolved_cmd" == "help" ]]; then
      print_help
      exit 0
    elif [[ "$resolved_cmd" == "mkp" || "$resolved_cmd" == "run" || "$resolved_cmd" == "doctor" || "$resolved_cmd" == "config" ]]; then
      shift
      exec bash "$MODULES_DIR/cmd_${resolved_cmd}.sh" "$@"
    else
      echo "Unknown command: $cmd"
      echo
      print_help
      exit 1
    fi
    ;;
esac